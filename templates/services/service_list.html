{% extends "base.html" %}
{% load static %}

{% block content %}
<!-- Karusel -->
<div id="carouselExampleDark" class="carousel carousel-dark slide">
  <div class="carousel-indicators">
    <button type="button" data-bs-target="#carouselExampleDark" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
    <button type="button" data-bs-target="#carouselExampleDark" data-bs-slide-to="1" aria-label="Slide 2"></button>
    <button type="button" data-bs-target="#carouselExampleDark" data-bs-slide-to="2" aria-label="Slide 3"></button>
  </div>
  <div class="carousel-inner">
    <div class="carousel-item active" data-bs-interval="10000">
      <img src="{% static 'images/telegramlogo.png' %}" class="d-block w-100" alt="Telegram">
      <div class="carousel-caption d-none d-md-block">
        <h5>Telegram xizmatlari</h5>
      </div>
    </div>
    <div class="carousel-item" data-bs-interval="2000">
      <img src="{% static 'images/instagramlogo.jpeg' %}" class="d-block w-100" alt="Instagram">
      <div class="carousel-caption d-none d-md-block">
        <h5>Instagram xizmatlari</h5>
      </div>
    </div>
    <div class="carousel-item">
      <img src="{% static 'images/youtube.png' %}" class="d-block w-100" alt="YouTube">
      <div class="carousel-caption d-none d-md-block">
        <h5>YouTube xizmatlari</h5>
      </div>
    </div>
  </div>
  <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleDark" data-bs-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="visually-hidden">Previous</span>
  </button>
  <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleDark" data-bs-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="visually-hidden">Next</span>
  </button>
</div>

<!-- Xizmatlar qismi -->
<div class="container mt-5">
  <h1 class="text-center mb-4">SMM Xizmatlar</h1>
  
  <div class="mb-4">
    <label for="searchInput">Qidiruv:</label>
    <input type="text" id="searchInput" class="form-control" placeholder="Platforma yoki kategoriya bo'yicha qidirish">
  </div>
  
  
  <!-- Platforma tanlash -->
  <div class="mb-4">
    <label for="platformSelect">Platforma:</label>
    <select id="platformSelect" class="form-select">
      <option value="all">Barchasi</option>
      <option value="youtube">YouTube</option>
      <option value="telegram">Telegram</option>
      <option value="instagram">Instagram</option>
    </select>
  </div>
  
  
  <!-- Kategoriyalar -->
  <div class="mb-4">
    <label for="categorySelect">Kategoriyalar:</label>
    <select id="categorySelect" class="form-select">
      <option value="all">Barchasi</option>
      {% for category in categories %}
      <option value="{{ category.id }}">{{ category.name }}</option>  <!-- Kategoriyalar dinamik yuklanadi -->
      {% endfor %}
    </select>
  </div>
  
  <!-- Xizmat tanlash -->
  <div class="mb-4">
    <label for="serviceSelect">Xizmat tanlash:</label>
    <select id="serviceSelect" class="form-select">
      <option value="all">Barchasi</option>
      <!-- Xizmatlar dinamik yuklanadi -->
    </select>
  </div>
  
  <!-- URL qo'shish -->
  <div class="mb-4">
    <label for="pageUrl">Xizmatni yuborish </label>
    <input type="url" id="pageUrl" class="form-control" placeholder="Masalan, https://yourwebsite.com/">
  </div>
  
  
  <!-- Dinamik Xizmatlar Ro'yxati -->
  <div class="row" id="serviceList"></div>
  
  <!-- Xizmatlar tavsilotlari modal -->
  <div class="modal fade" id="serviceDetailModal" tabindex="-1" aria-labelledby="serviceDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="serviceDetailModalLabel">Xizmat tavsilotlari</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h5 id="serviceName"></h5>
          <p id="serviceDescription"></p>
          <small id="serviceCompletionTime"></small><br>
          <p><strong>Narx:</strong> <span id="servicePrice"></span> so‘m</p>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block scripts %}
<script>
  const platformSelect = document.getElementById('platformSelect');
  const categorySelect = document.getElementById('categorySelect');
  const serviceSelect = document.getElementById('serviceSelect');
  const searchInput = document.getElementById('searchInput');
  
  // Kategoriyalarni yuklash
  platformSelect.addEventListener('change', fetchCategories);
  
  async function fetchCategories() {
    const platform = platformSelect.value;
    const url = platform !== 'all' ? `/api/categories/${platform}/` : `/api/categories/`;
    
    try {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      const categories = await response.json();
      populateCategories(categories);
      fetchServices();
    } catch (error) {
      console.error('Kategoriyalarni yuklashda xatolik:', error);
    }
  }
  
  function populateCategories(categories) {
    categorySelect.innerHTML = '<option value="all">Barchasi</option>';
    categories.forEach(category => {
      const option = document.createElement("option");
      option.value = category.id;
      option.textContent = category.name;
      categorySelect.appendChild(option);
    });
  }
  
  // Kategoriyani tanlaganda xizmatlarni yuklash
  categorySelect.addEventListener('change', fetchServices);
  
  
  // Xizmatlarni yuklash funksiyasi
  async function fetchServices() {
    let searchTerm = searchInput.value; // Agar qidiruv maydoni bo'lsa
    let platform = platformSelect.value; // Platforma tanlovidan qiymat
    let category = categorySelect.value; // Kategoriya tanlovidan qiymat
    let url = `/api/services/?platform=${platform}&category=${category}&search=${searchTerm}`; // API URL
    
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error('Network response was not ok');
      
      const services = await response.json();
      displayServices(services); // DOM ni yangilash
      populateServiceSelect(services); // Xizmatlarni tanlash ro'yxatiga yuklash
    } catch (error) {
      console.error('Error loading services:', error);
    }
  }
  
  // Xizmat tanlash uchun dinamik ro'yxatni to'ldirish
  function populateServiceSelect(services) {
    const serviceSelect = document.getElementById('serviceSelect');
    serviceSelect.innerHTML = '<option value="all">Barchasi</option>'; // Barchasi opsiyasi
    services.forEach(service => {
      const option = document.createElement("option");
      option.value = service.id; // Xizmatning ID sini opsiya qiymati sifatida
      option.textContent = service.name; // Xizmat nomini opsiya matni sifatida
      serviceSelect.appendChild(option); // Opsiyani tanlovga qo'shish
    });
  }
  
  // Dastlabki xizmatlarni yuklash
  fetchServices();
  
  
  // Xizmatlar ro'yxatini ko'rsatish
  function displayServices(services) {
    const serviceList = document.getElementById("serviceList");
    serviceList.innerHTML = "";
    services.forEach(service => {
      const serviceItem = document.createElement("div");
      serviceItem.classList.add("col-md-4", "mb-4");
      serviceItem.innerHTML = `
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">${service.name}</h5>
            <p class="card-text">${service.description}</p>
            <small>Bajarilish vaqti: ${service.completion_time} daqiqa</small><br>
            <strong>Narx:</strong> ${service.price} so‘m<br>
            <button class="btn btn-primary btn-details" data-service-id="${service.id}">Batafsil</button>
          </div>
        </div>
      `;
      serviceList.appendChild(serviceItem);
    });
  }
  
  
  // Xizmat tafsilotlarini modalda ko'rsatish
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('btn-details')) {
      const serviceId = e.target.getAttribute('data-service-id');
      showServiceDetails(serviceId);
    }
  });
  
  async function showServiceDetails(serviceId) {
    try {
      const response = await fetch(`/api/services/${serviceId}/`);
      const service = await response.json();
      
      document.getElementById('serviceName').textContent = service.name;
      document.getElementById('serviceDescription').textContent = service.description;
      document.getElementById('serviceCompletionTime').textContent = `Bajarilish vaqti: ${service.completion_time} daqiqa`;
      document.getElementById('servicePrice').textContent = service.price;
      
      const serviceDetailModal = new bootstrap.Modal(document.getElementById('serviceDetailModal'));
      serviceDetailModal.show();
    } catch (error) {
      console.error('Xizmat tafsilotlarini ko‘rsatishda xatolik:', error);
    }
  }
  
  // Qidiruv bo'yicha xizmatlarni filtrlash
  searchInput.addEventListener('input', fetchServices);
</script>
{% endblock %}
